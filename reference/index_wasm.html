<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pure Dupes - Find Duplicates (WASM)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Go WASM support -->
    <script src="wasm_exec.js"></script>
    <style>
        :root {
            --accent: #CD7F59;
            --accent-light: #E0A388;
            --accent-dark: #B06D4A;
            --bg: #F5F3EF;
            --text: #1A1A1A;
            --gray: #6B6B6B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        .fab {
            position: fixed;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s;
            z-index: 1000;
        }

        .fab:hover {
            background: var(--accent-dark);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab-primary {
            bottom: 24px;
            right: 24px;
        }

        .fab-secondary {
            bottom: 92px;
            right: 24px;
            width: 48px;
            height: 48px;
            font-size: 20px;
            background: white;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .fab-secondary:hover {
            background: var(--bg);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .compact-input {
            border: 1px solid #D9D9D9;
            background: white;
            border-radius: 8px;
            transition: border 0.2s;
        }

        .compact-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            border: 1px solid #E5E5E5;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .tree-node {
            transition: background 0.1s;
        }

        .tree-node:hover {
            background: #F9F9F9;
        }

        .kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            background: #F5F5F5;
            border: 1px solid #D9D9D9;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
        }

        .filter-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideInUp 0.3s ease-out;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #F5F5F5;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dark);
        }
    </style>
</head>
<body>
<div id="root"></div>

<script>
    // Initialize Go WASM
    let wasmReady = false;
    const go = new Go();
    
    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
        .then((result) => {
            go.run(result.instance);
            wasmReady = true;
            console.log("‚úÖ WASM module loaded and ready");
        })
        .catch((err) => {
            console.error("‚ùå Failed to load WASM:", err);
        });
</script>

<script type="text/babel">
    const {useState, useEffect, useRef} = React;

    function App() {
        const [result, setResult] = useState(null);
        const [loading, setLoading] = useState(false);
        const [selectedFile, setSelectedFile] = useState(null);
        const [expanded, setExpanded] = useState({});
        const [showSettingsModal, setShowSettingsModal] = useState(false);
        const [showFilterModal, setShowFilterModal] = useState(false);
        const [searchQuery, setSearchQuery] = useState('');
        const [filters, setFilters] = useState({fullDup: false, partialDup: false, unique: false});
        const [settings, setSettings] = useState({
            threshold: 0.8,
            chunkSize: 4096
        });

        const hasActiveFilters = filters.fullDup || filters.partialDup || filters.unique;

        useEffect(() => {
            const handleKeyDown = (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    if (result) {
                        setShowFilterModal(true);
                    } else {
                        setShowSettingsModal(true);
                    }
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [result]);

        const analyze = async (fileList) => {
            if (!wasmReady) {
                alert('WASM module is still loading, please wait...');
                return;
            }

            setLoading(true);
            setSelectedFile(null);
            setSearchQuery('');
            
            try {
                // Read all files
                const files = await Promise.all(
                    Array.from(fileList).map(async (file) => {
                        const arrayBuffer = await file.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        return {
                            name: file.name,
                            path: file.webkitRelativePath || file.name,
                            size: file.size,
                            data: uint8Array
                        };
                    })
                );

                console.log(`üìÅ Processing ${files.length} files...`);

                // Call WASM function
                const resultJSON = analyzeFiles(
                    files,
                    settings.threshold,
                    settings.chunkSize
                );

                const data = JSON.parse(resultJSON);
                
                if (data.error) {
                    throw new Error(data.error);
                }

                setResult(data);
                setExpanded({[data.RootTree.Path]: true});
                console.log('‚úÖ Analysis complete');
            } catch (err) {
                console.error('Analysis error:', err);
                alert('Error: ' + err.message);
            } finally {
                setLoading(false);
            }
        };

        const formatBytes = (bytes) => {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        };

        const toggleExpanded = (path) => {
            setExpanded(prev => ({...prev, [path]: !prev[path]}));
        };

        function matchesDescendantWithFilters(node, query, filters) {
            const matchesQuery = !query || (
                node.Name && node.Name.toLowerCase().includes(query.toLowerCase())
            );

            const matchesFilter = !hasActiveFilters || (
                (filters.fullDup && node.BestMatch >= 1.0) ||
                (filters.partialDup && node.BestMatch > 0 && node.BestMatch < 1.0) ||
                (filters.unique && node.BestMatch === 0)
            );

            if (!node.IsDir) {
                return matchesQuery && matchesFilter;
            }

            return node.Children.some(child => matchesDescendantWithFilters(child, query, filters));
        }

        function FileTreeNode({node, onFileClick, expanded, onToggle, searchQuery, filters}) {
            const hasMatch = matchesDescendantWithFilters(node, searchQuery, filters);
            
            if (!hasMatch) return null;

            const isExpanded = expanded[node.Path];
            const matchCount = node.Matches ? node.Matches.length : 0;

            const getIcon = () => {
                if (node.IsDir) return isExpanded ? 'üìÇ' : 'üìÅ';
                if (node.BestMatch >= 1.0) return 'üî¥';
                if (node.BestMatch > 0) return 'üü†';
                return 'üìÑ';
            };

            const getColorClass = () => {
                if (!node.IsDir) {
                    if (node.BestMatch >= 1.0) return 'text-red-600';
                    if (node.BestMatch > 0) return 'text-orange-600';
                }
                return 'text-gray-700';
            };

            return (
                <div>
                    <div 
                        className={`tree-node flex items-center py-1 px-2 cursor-pointer rounded ${getColorClass()}`}
                        onClick={() => {
                            if (node.IsDir) {
                                onToggle(node.Path);
                            } else {
                                onFileClick(node);
                            }
                        }}
                    >
                        <span className="mr-2">{getIcon()}</span>
                        <span className="flex-1 font-mono text-sm truncate">{node.Name}</span>
                        {!node.IsDir && matchCount > 0 && (
                            <span className="text-xs px-2 py-0.5 rounded bg-gray-100">
                                {matchCount}
                            </span>
                        )}
                    </div>
                    {node.IsDir && isExpanded && node.Children && (
                        <div className="ml-4">
                            {node.Children.map((child, idx) => (
                                <FileTreeNode 
                                    key={idx}
                                    node={child}
                                    onFileClick={onFileClick}
                                    expanded={expanded}
                                    onToggle={onToggle}
                                    searchQuery={searchQuery}
                                    filters={filters}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function SettingsModal({isOpen, onClose, settings, setSettings, onAnalyze}) {
            const [localSettings, setLocalSettings] = useState(settings);
            const fileInputRef = useRef(null);

            if (!isOpen) return null;

            const handleAnalyze = () => {
                setSettings(localSettings);
                onClose();
                fileInputRef.current?.click();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content slide-in" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <h2 className="text-xl font-semibold mb-4">Settings</h2>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">
                                        Similarity Threshold
                                    </label>
                                    <input
                                        type="range"
                                        min="0.5"
                                        max="1.0"
                                        step="0.05"
                                        value={localSettings.threshold}
                                        onChange={e => setLocalSettings({...localSettings, threshold: parseFloat(e.target.value)})}
                                        className="w-full"
                                    />
                                    <div className="text-sm text-gray-600 mt-1">
                                        {(localSettings.threshold * 100).toFixed(0)}%
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">
                                        Chunk Size (bytes)
                                    </label>
                                    <select
                                        value={localSettings.chunkSize}
                                        onChange={e => setLocalSettings({...localSettings, chunkSize: parseInt(e.target.value)})}
                                        className="compact-input w-full px-3 py-2"
                                    >
                                        <option value="1024">1 KB</option>
                                        <option value="2048">2 KB</option>
                                        <option value="4096">4 KB (default)</option>
                                        <option value="8192">8 KB</option>
                                        <option value="16384">16 KB</option>
                                    </select>
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                                    <p className="font-medium mb-1">üí° Using File System Access API</p>
                                    <p className="text-gray-600">
                                        Select files or a directory. All processing happens in your browser - no data is uploaded!
                                    </p>
                                </div>
                            </div>

                            <div className="flex gap-3 mt-6">
                                <button
                                    onClick={handleAnalyze}
                                    className="flex-1 px-4 py-2 rounded-lg font-medium text-white"
                                    style={{background: 'var(--accent)'}}
                                >
                                    Choose Files
                                </button>
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 rounded-lg border border-gray-300"
                                >
                                    Cancel
                                </button>
                            </div>

                            <input
                                ref={fileInputRef}
                                type="file"
                                multiple
                                webkitdirectory=""
                                directory=""
                                onChange={(e) => {
                                    if (e.target.files && e.target.files.length > 0) {
                                        onAnalyze(e.target.files);
                                    }
                                }}
                                style={{display: 'none'}}
                            />
                        </div>
                    </div>
                </div>
            );
        }

        function FilterModal({isOpen, onClose, filters, setFilters, searchQuery, setSearchQuery}) {
            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content slide-in" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <h2 className="text-xl font-semibold mb-4">Search & Filter</h2>
                            
                            <div className="mb-4">
                                <input
                                    type="text"
                                    placeholder="Search files..."
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    className="compact-input w-full px-4 py-2"
                                    autoFocus
                                />
                            </div>

                            <div className="space-y-2">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={filters.fullDup}
                                        onChange={e => setFilters({...filters, fullDup: e.target.checked})}
                                    />
                                    <span>üî¥ Full Duplicates</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={filters.partialDup}
                                        onChange={e => setFilters({...filters, partialDup: e.target.checked})}
                                    />
                                    <span>üü† Partial Duplicates</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={filters.unique}
                                        onChange={e => setFilters({...filters, unique: e.target.checked})}
                                    />
                                    <span>‚ú® Unique Files</span>
                                </label>
                            </div>

                            <button
                                onClick={onClose}
                                className="w-full mt-6 px-4 py-2 rounded-lg font-medium text-white"
                                style={{background: 'var(--accent)'}}
                            >
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen">
                {/* Header */}
                <div className="bg-white border-b border-gray-200">
                    <div className="max-w-6xl mx-auto px-6 py-4">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold" style={{color: 'var(--text)'}}>
                                    üîç pure-dupes
                                </h1>
                                <p className="text-sm" style={{color: 'var(--gray)'}}>
                                    Client-side duplicate finder ‚Ä¢ Powered by WASM
                                </p>
                            </div>
                            {result && (
                                <div className="flex flex-wrap gap-2">
                                    <div className="stat-badge">
                                        <span className="mr-1">üìÅ</span>
                                        {result.TotalFiles} files
                                    </div>
                                    <div className="stat-badge">
                                        <span className="mr-1">‚ú®</span>
                                        {result.UniqueFiles} unique
                                    </div>
                                    <div className="stat-badge">
                                        <span className="mr-1">üî¥</span>
                                        {result.FullDupCount} full, {result.PartialDupCount} partial
                                    </div>
                                    <div className="stat-badge">
                                        <span className="mr-1">üíæ</span>
                                        {formatBytes(result.SpaceSaved)}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* Main Content */}
                <div className="max-w-6xl mx-auto px-6 py-6">
                    {!result ? (
                        <div className="bg-white rounded-xl p-12 text-center">
                            <div className="text-6xl mb-4">üîç</div>
                            <h2 className="text-2xl font-semibold mb-2" style={{color: 'var(--text)'}}>
                                Ready to find duplicates
                            </h2>
                            <p className="mb-6" style={{color: 'var(--gray)'}}>
                                Click the button below or press <span className="kbd">‚åòK</span> to choose files
                            </p>
                            <p className="mb-6 text-sm" style={{color: 'var(--gray)'}}>
                                ‚ú® All processing happens locally in your browser - 100% private!
                            </p>
                            <button
                                onClick={() => setShowSettingsModal(true)}
                                className="px-8 py-3 rounded-lg font-medium text-white"
                                style={{background: 'var(--accent)'}}
                                disabled={!wasmReady}
                            >
                                {wasmReady ? 'Choose Files' : 'Loading WASM...'}
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-12 gap-6">
                            {/* File Tree */}
                            <div className="col-span-7 bg-white rounded-xl p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-semibold" style={{color: 'var(--text)'}}>
                                        File Tree
                                    </h2>
                                    <div className="flex items-center gap-2">
                                        {(searchQuery || hasActiveFilters) && (
                                            <button
                                                onClick={() => {
                                                    setSearchQuery('');
                                                    setFilters({fullDup: false, partialDup: false, unique: false});
                                                }}
                                                className="text-xs px-3 py-1 rounded"
                                                style={{color: 'var(--gray)'}}
                                            >
                                                Clear filters ‚úï
                                            </button>
                                        )}
                                        <button
                                            onClick={() => setShowFilterModal(true)}
                                            className="text-xs px-3 py-1 rounded border"
                                            style={{borderColor: '#D9D9D9'}}
                                        >
                                            <span className="kbd mr-1">‚åòK</span> Filter
                                        </button>
                                    </div>
                                </div>
                                <div className="max-h-[600px] overflow-y-auto scrollbar-thin font-mono text-sm">
                                    <FileTreeNode
                                        node={result.RootTree}
                                        onFileClick={setSelectedFile}
                                        expanded={expanded}
                                        onToggle={toggleExpanded}
                                        searchQuery={searchQuery}
                                        filters={filters}
                                    />
                                </div>
                            </div>

                            {/* Match Details */}
                            <div className="col-span-5 bg-white rounded-xl p-6">
                                <h2 className="text-lg font-semibold mb-4" style={{color: 'var(--text)'}}>
                                    Match Details
                                </h2>
                                {selectedFile ? (
                                    <div>
                                        <div className="mb-4 p-3 rounded" style={{background: 'var(--bg)'}}>
                                            <div className="text-xs" style={{color: 'var(--gray)'}}>Selected:</div>
                                            <div className="font-mono text-sm break-all mt-1"
                                                 style={{color: 'var(--text)'}}>
                                                {selectedFile.Name}
                                            </div>
                                            <div className="text-xs mt-1" style={{color: 'var(--gray)'}}>
                                                {formatBytes(selectedFile.Size)}
                                            </div>
                                        </div>

                                        <div className="space-y-3 max-h-[500px] overflow-y-auto scrollbar-thin">
                                            {selectedFile.Matches.map((match, idx) => (
                                                <div
                                                    key={idx}
                                                    className={`p-4 rounded-lg ${
                                                        match.Similarity >= 1.0
                                                            ? 'bg-red-50 border border-red-200'
                                                            : 'bg-orange-50 border border-orange-200'
                                                    }`}
                                                >
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className={`text-xs font-medium px-2 py-1 rounded ${
                                                            match.Similarity >= 1.0
                                                                ? 'bg-red-100 text-red-700'
                                                                : 'bg-orange-100'
                                                        }`}
                                                              style={match.Similarity >= 1.0 ? {} : {color: 'var(--accent)'}}>
                                                            {match.Similarity >= 1.0 ? 'üî¥ DUPE' : `üü† ${(match.Similarity * 100).toFixed(0)}%`}
                                                        </span>
                                                    </div>

                                                    <div className="font-mono text-xs break-all p-2 rounded bg-white">
                                                        üìç {match.TargetPath}
                                                    </div>

                                                    <div className="text-xs mt-2" style={{color: 'var(--gray)'}}>
                                                        Shared: {formatBytes(match.SharedSize)}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12" style={{color: 'var(--gray)'}}>
                                        <div className="text-4xl mb-2">üëÜ</div>
                                        Click a file to see matches
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                {/* FABs */}
                {!loading && (
                    <>
                        <button
                            onClick={() => result ? setShowFilterModal(true) : setShowSettingsModal(true)}
                            className="fab fab-primary"
                            title={result ? "Search & Filter (‚åòK)" : "Choose Files (‚åòK)"}
                            disabled={!wasmReady}
                        >
                            {result ? 'üîç' : '‚öôÔ∏è'}
                        </button>
                        {result && (
                            <button
                                onClick={() => setShowSettingsModal(true)}
                                className="fab fab-secondary"
                                title="Settings"
                            >
                                ‚öôÔ∏è
                            </button>
                        )}
                    </>
                )}

                {loading && (
                    <div className="fab fab-primary" style={{cursor: 'default'}}>
                        <div className="animate-spin">‚öôÔ∏è</div>
                    </div>
                )}

                {/* Modals */}
                <FilterModal
                    isOpen={showFilterModal}
                    onClose={() => setShowFilterModal(false)}
                    filters={filters}
                    setFilters={setFilters}
                    searchQuery={searchQuery}
                    setSearchQuery={setSearchQuery}
                />

                <SettingsModal
                    isOpen={showSettingsModal}
                    onClose={() => setShowSettingsModal(false)}
                    settings={settings}
                    setSettings={setSettings}
                    onAnalyze={analyze}
                />
            </div>
        );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
